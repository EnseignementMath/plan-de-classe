<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plan de classe</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { text-align: center; margin-bottom: 30px; }
    .container { display: flex; gap: 20px; align-items: flex-start; }

    .left-panel { display: flex; flex-direction: column; gap: 10px; }
    .lien-box {
      width: 120px; padding: 10px; background-color: #87CEEB;
      border-radius: 5px; text-align: center; cursor: pointer;
      user-select: none; transition: background-color .3s, color .3s;
    }
    .lien-box:hover { background-color: #00bfff; }
    #mode-controle-box.active { background-color: #ff4d4d; color: #fff; }

    .cases {
      display: flex;
      flex-direction: column;
      gap: 18px;
      align-items: flex-start;
    }
    .case-container {
      display: inline-flex;
      background-color: #87CEEB;
      border-radius: 5px;
      overflow: hidden;
    }
    .subcase {
      padding: 8px 16px;
      border-right: 1px solid rgba(255,255,255,.7);
      cursor: pointer;
      transition: background-color .3s, color .3s, box-shadow .2s;
      width: fit-content;
      max-width: 340px;
      min-width: 50px;
      min-height: 30px;
      word-break: break-word;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      background: inherit;
      box-sizing: border-box;
      user-select: none;
    }
    .subcase:last-child { border-right: none; }
    .subcase.selected { background: #006400; color: #fff; }
    .subcase.completed { background: #ff4d4d !important; color: #fff !important; }
    .header { display: flex; align-items: center; gap: 8px; }
    .toggle { cursor: pointer; }
    .title, .title-link { font-weight: bold; }
    .options { margin-top: 8px; display: none; padding-left: 4px; }
    .result { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; min-width: 220px; }
    #result-list { list-style: none; padding: 0; margin: 0; }
    #result-list li { margin-bottom: 5px; cursor: pointer; }
    li.detail-select { padding-left: 20px; margin-bottom: 10px; }
    li.detail-select label { display: block; cursor: pointer; }
    #controle-result .control-message {
      text-decoration: underline; margin-top: 10px; font-weight: bold;
    }
    .footer-container { text-align: center; margin-top: 30px; }
    .footer-box {
      display: inline-block; padding: 10px 20px;
      border: 2px solid #000; border-radius: 5px; font-weight: bold;
    }
    .dragging { opacity: 0.3; box-shadow: 0 0 8px #007; }
    .drag-over { outline: 2px dashed #007; background: #d7f7fa !important; }
    .placement-controls { margin-bottom: 10px; }
    .placement-controls input, .placement-controls textarea {
      margin: 0 6px 6px 0; padding: 2px 4px; font-size: 1em;
    }
    @media (max-width:600px) {
      .container { flex-direction: column; }
      .result { min-width: 120px; }
      .case-container { flex-wrap: wrap; }
      .subcase { min-width: 28px; font-size: 0.95em; padding: 6px 4px; }
    }
  </style>
</head>
<body>
  <h1>Plan de classe</h1>

  <div class="container">
    <div class="left-panel">
      <div class="lien-box" id="lien-box">Lien</div>
      <div class="lien-box" id="appel-box">Appel terminé</div>
      <div class="lien-box" id="mode-controle-box">Mode contrôle</div>
      <div class="lien-box" id="reset-box" style="background:#f9b;">Réinitialiser</div>
      <div id="appel-result"></div>
    </div>

    <div class="cases" id="cases"></div>

    <div class="result"></div>
  </div>

  <div class="footer-container">
    <div class="footer-box">Tableau</div>
  </div>

<script>
const detailsOptions = {
  "Comportement": [
    "Insulte envers le professeur","Insulte envers un camarade","Insolence",
    "Langage familier","Refus de se taire","Refus de s'asseoir","Bavardages",
    "Imitation de bruitages","Usage du téléphone","Retard",
    "Insiste pour aller aux toilettes"
  ],
  "Travail non fait": [
    "Exercice maison non rendu","Copie blanche","Leçon non apprise",
    "Refus de participer","Réponse inappropriée"
  ],
  "Oubli de matériel": [
    "Pas de stylo","Pas de trousse","Pas de rapporteur","Pas de compas",
    "Pas ses codes","Pas de carnet","Pas de cahier","Pas de calculatrice",
    "Pas de mouchoirs","Pas de copie"
  ]
};

let lignes, colonnes, prenoms = [];
let plan = [];

const casesContainer = document.getElementById('cases');
const resultPanel = document.querySelector('.result');

function demandeInfosForm() {
  resultPanel.innerHTML = `
    <form id="placementForm" class="placement-controls">
      <label>Lignes : <input type="number" id="nblignes" min="1" max="16" value="5" required></label>
      <label>Colonnes : <input type="number" id="nbcolonnes" min="1" max="16" value="6" required></label><br>
      <label>Liste des prénoms (un par ligne ou séparés par virgule):<br>
        <textarea id="listePrenoms" rows="6" style="width:96%;" required>
Aya,Roumaissa,Mohamed,Maryam,Merve,Néhémie,Nemaaly,Théo,Mathys,Sheldon,Inahya,Sam Ismaël,Aissa,Carlos,Malone,Raphaël,Nour,Jilyan,Inès,Ismael</textarea></label><br>
      <button type="submit">Créer la grille</button>
    </form>
  `;
  casesContainer.innerHTML = '';
  document.getElementById('placementForm').onsubmit = function(e) {
    e.preventDefault();
    lignes = parseInt(document.getElementById('nblignes').value,10);
    colonnes = parseInt(document.getElementById('nbcolonnes').value,10);
    let listePrenoms = document.getElementById('listePrenoms').value;
    prenoms = listePrenoms.split(/[\n,;]+/).map(x=>x.trim()).filter(Boolean);
    if (prenoms.length > lignes*colonnes) {
      alert("Plus de prénoms que de places !");
      return;
    }
    plan = Array.from({length: lignes}, () => Array(colonnes).fill(""));
    afficherPlacement();
  }
}

// -------- PHASE PLACEMENT --------
let prenomChoisi = null;
function afficherPlacement() {
  // Panel de placement
  resultPanel.innerHTML = `<div><b>Placez les élèves (clic prénom puis clic case)...</b></div>`;
  const list = document.createElement('div');
  prenoms.forEach(prenom => {
    const btn = document.createElement('button');
    btn.textContent = prenom;
    btn.style.margin = '3px';
    btn.onclick = () => {
      prenomChoisi = prenom;
      [...list.querySelectorAll('button')].forEach(b => b.style.background = '');
      btn.style.background = '#ffea00';
    };
    list.appendChild(btn);
  });
  resultPanel.appendChild(list);

  // Génère la grille
  casesContainer.innerHTML = '';
  for (let r = 0; r < lignes; r++) {
    const cont = document.createElement('div');
    cont.className = 'case-container';
    for (let c = 0; c < colonnes; c++) {
      const sc = document.createElement('div');
      sc.className = 'subcase';
      sc.textContent = plan[r][c] || '…';
      sc.style.minWidth = '50px';
      sc.onclick = () => {
        if (!prenomChoisi) return;
        if (plan[r][c]) return alert("Case occupée !");
        plan[r][c] = prenomChoisi;
        prenoms = prenoms.filter(p => p !== prenomChoisi);
        prenomChoisi = null;
        afficherPlacement();
        if (prenoms.length === 0) setTimeout(() => genererInterfaceFinale(), 250);
      };
      cont.appendChild(sc);
    }
    casesContainer.appendChild(cont);
  }

  // Réinit bouton
  const reset = document.createElement('button');
  reset.textContent = 'Réinitialiser placement';
  reset.style.marginTop = '16px';
  reset.onclick = () => { demandeInfosForm(); };
  resultPanel.appendChild(reset);
}

// -------- PHASE INTERFACE FINALE --------

function genererInterfaceFinale() {
  resultPanel.innerHTML = `<ul id="result-list"></ul><div id="controle-result"></div>`;
  casesContainer.innerHTML = '';
  // Génère la grille + events
  let matrice = plan.map(ligne => ligne.slice());
  let num = 1;
  matrice.forEach((ligne, r) => {
    const cont = document.createElement('div');
    cont.className = 'case-container';
    ligne.forEach((prenom, c) => {
      if (!prenom) return;
      const sc = document.createElement('div');
      sc.className = 'subcase';
      sc.dataset.case = num;
      sc.innerHTML = `<div class="header">
        <input type="checkbox" class="toggle" data-case="${num}">
        <span class="title">${prenom}</span>
      </div>
      <div class="options" style="display:none"></div>`;
      let opts = sc.querySelector('.options');
      Object.keys(detailsOptions).forEach(cat => {
        const lbl = document.createElement('label');
        const inp = document.createElement('input');
        inp.type = 'checkbox';
        inp.dataset.case = num;
        inp.value = cat;
        lbl.append(inp, ' ' + cat);
        opts.append(lbl, document.createElement('br'));
      });
      cont.appendChild(sc);
      num++;
    });
    casesContainer.appendChild(cont);
  });

  // --- Drag & Drop ---
  enableDragAndDropOnGrid(matrice);

  // --- Appel, contrôle, infractions, export ---
  prepareFonctionnalites(matrice);
}

// -------- DRAG & DROP --------
function enableDragAndDropOnGrid(matrice) {
  let dragFrom = null;

  // Pour chaque subcase, events
  let n = 0;
  matrice.forEach((ligne, r) => {
    ligne.forEach((prenom, c) => {
      if (!prenom) return;
      n++;
      const sc = document.querySelector(`.subcase[data-case="${n}"]`);
      // Drag souris
      sc.draggable = true;
      sc.addEventListener('dragstart', e => {
        dragFrom = {r, c, n};
        sc.classList.add('dragging');
        e.dataTransfer.setData("text/plain", "drag");
      });
      sc.addEventListener('dragend', e => {
        sc.classList.remove('dragging');
      });

      // Drag over/drop (souris)
      sc.addEventListener('dragover', e => {
        e.preventDefault();
        sc.classList.add('drag-over');
      });
      sc.addEventListener('dragleave', e => {
        sc.classList.remove('drag-over');
      });
      sc.addEventListener('drop', e => {
        e.preventDefault();
        sc.classList.remove('drag-over');
        let n2 = parseInt(sc.dataset.case,10);
        if (!dragFrom || dragFrom.n === n2) return;
        let {r: r1, c: c1} = dragFrom;
        // trouver r2,c2 via n2
        let k=1, r2=0, c2=0, found=false;
        for(let i=0;i<matrice.length;i++) for(let j=0;j<matrice[0].length;j++)
          if (matrice[i][j]) { if (k++===n2){ r2=i;c2=j;found=true;break; } }
        if (!found) return;
        // swap
        let tmp = matrice[r1][c1]; matrice[r1][c1]=matrice[r2][c2]; matrice[r2][c2]=tmp;
        plan = matrice.map(row=>row.slice());
        genererInterfaceFinale();
      });

      // Touch events
      let touchTimer;
      sc.addEventListener('touchstart', function(e) {
        touchTimer = setTimeout(() => {
          dragFrom = {r, c, n};
          sc.classList.add('dragging');
        }, 180);
      });
      sc.addEventListener('touchend', function(e) {
        clearTimeout(touchTimer);
        setTimeout(()=>sc.classList.remove('dragging'), 150);
      });
      sc.addEventListener('touchmove', function(e) {
        // visual: pas de vrai ghost
        e.preventDefault();
        let touch = e.touches[0];
        let elem = document.elementFromPoint(touch.clientX, touch.clientY);
        if (elem && elem.classList.contains('subcase')) elem.classList.add('drag-over');
      });
      sc.addEventListener('touchend', function(e) {
        document.querySelectorAll('.drag-over').forEach(e=>e.classList.remove('drag-over'));
        let touch = e.changedTouches[0];
        let elem = document.elementFromPoint(touch.clientX, touch.clientY);
        if (dragFrom && elem && elem.classList.contains('subcase') && elem !== sc) {
          let n2 = parseInt(elem.dataset.case,10);
          if (dragFrom.n === n2) return;
          let k=1, r2=0, c2=0, found=false;
          for(let i=0;i<matrice.length;i++) for(let j=0;j<matrice[0].length;j++)
            if (matrice[i][j]) { if (k++===n2){ r2=i;c2=j;found=true;break; } }
          if (!found) return;
          let {r: r1, c: c1} = dragFrom;
          let tmp = matrice[r1][c1]; matrice[r1][c1]=matrice[r2][c2]; matrice[r2][c2]=tmp;
          plan = matrice.map(row=>row.slice());
          genererInterfaceFinale();
        }
        dragFrom = null;
      });
    });
  });
}

// -------- AUTRES FONCTIONNALITÉS --------
function prepareFonctionnalites(matrice) {
  // Appel présents/absents
  document.querySelectorAll('.subcase').forEach(sc => {
    sc.addEventListener('click', e => {
      if (e.target.tagName === 'INPUT') return;
      sc.classList.toggle('selected');
    });
  });

  // Boutons infractions
  document.querySelectorAll('.toggle').forEach(toggle => {
    toggle.addEventListener('change', function() {
      const sc = this.closest('.subcase');
      const opts = sc.querySelector('.options');
      if (this.checked) opts.style.display = 'block';
      else {
        opts.style.display = 'none';
        opts.querySelectorAll('input[type=checkbox]').forEach(cb => {
          if (cb.checked) { removeResult(cb.dataset.case, cb.value); cb.checked = false; }
        });
      }
    });
  });
  document.querySelectorAll('.options input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
      this.checked ? addResult(this.dataset.case, this.value)
                   : removeResult(this.dataset.case, this.value);
    });
  });

  // Détail des infractions (li)
  const resultList = document.getElementById('result-list');
  resultList.onclick = function(e) {
    const li = e.target;
    if (li.tagName !== 'LI' || li.classList.contains('detail-select')) return;
    const prev = resultList.querySelector('.detail-select');
    if (prev) prev.remove();
    const [prenom, rubrique] = li.textContent.split(' : ');
    const opts = detailsOptions[rubrique];
    if (!opts) return;
    const c = findCaseByPrenom(matrice, prenom);
    const sel = document.createElement('li');
    sel.className = 'detail-select';
    opts.forEach(opt => {
      const lbl = document.createElement('label');
      const cb  = document.createElement('input');
      cb.type = 'checkbox'; cb.dataset.case = c; cb.value = opt;
      lbl.append(cb, ' ' + opt);
      sel.append(lbl, document.createElement('br'));
      cb.addEventListener('change', () => {
        if (cb.checked) {
          li.textContent = `${prenom} : ${rubrique} : ${opt}`;
          sel.remove();
        }
      });
    });
    li.insertAdjacentElement('afterend', sel);
  };
  function addResult(c,v){
    const id = `result-${c}-${v}`;
    if (!document.getElementById(id)) {
      const li = document.createElement('li');
      li.id = id;
      li.textContent = `${findPrenomByCase(matrice, c)} : ${v}`;
      resultList.append(li);
    }
  }
  function removeResult(c,v){
    const el = document.getElementById(`result-${c}-${v}`);
    if (!el) return;
    const nxt = el.nextElementSibling;
    if (nxt && nxt.classList.contains('detail-select')) nxt.remove();
    el.remove();
  }
  // Utilitaires pour retrouver prénom/case
  function findPrenomByCase(matrice, n) {
    let count = 1;
    for (const ligne of matrice) for (const nom of ligne)
      if (nom && count++ === parseInt(n)) return nom;
    return "Case " + n;
  }
  function findCaseByPrenom(matrice, prenom) {
    let count = 1;
    for (const ligne of matrice) for (const nom of ligne)
      if (nom && nom === prenom) return count;
      else if (nom) count++;
    return -1;
  }

  // Appel terminé
  document.getElementById('appel-box').onclick = () => {
    const subs = Array.from(document.querySelectorAll('.subcase'));
    const pres = subs.filter(sc => sc.classList.contains('selected'));
    const abs  = subs.filter(sc => !sc.classList.contains('selected'));
    let html = `<p>Élèves présents : ${pres.length}</p><p>Élèves absents :</p>`;
    if (abs.length) abs.forEach(sc => {
      html += `<p>${sc.querySelector('.title').textContent}</p>`;
    });
    else html += `<p>—</p>`;
    document.getElementById('appel-result').innerHTML = html;
  };

  // Mode contrôle et pages rendues
  const rendus = [], nomsRendus = [];
  const modeBtn = document.getElementById('mode-controle-box');
  const controleResult = document.getElementById('controle-result');
  let modeActive = false;
  modeBtn.onclick = () => {
    modeActive = !modeActive;
    modeBtn.classList.toggle('active', modeActive);
    controleResult.innerHTML = modeActive
      ? '<p class="control-message">A terminé le contrôle</p>'
      : '';
    if (!modeActive) { rendus.length = 0; nomsRendus.length = 0; }
    document.querySelectorAll('.subcase').forEach(sc => {
      const c = sc.dataset.case;
      if (modeActive) {
        const span = sc.querySelector('span.title');
        if (!span) return;
        const a = document.createElement('a');
        a.href = '#'; a.textContent = findPrenomByCase(matrice, c); a.className = 'title-link';
        a.addEventListener('click', e => {
          e.stopPropagation();
          const line = document.createElement('p');
          line.innerHTML = `${findPrenomByCase(matrice, c)} : page : <input type="number" min="1">`;
          controleResult.append(line);
          const input = line.querySelector('input');
          input.focus();
          input.addEventListener('keydown', evt => {
            if (evt.key === 'Enter') {
              const pages = parseInt(input.value, 10) || 0;
              line.textContent = `${findPrenomByCase(matrice, c)} : page : ${pages}`;
              sc.classList.add('completed');
              rendus.push({ case: c, pages });
              for (let i = 0; i < pages; i++) {
                nomsRendus.push(findPrenomByCase(matrice, c));
              }
            }
          });
        });
        span.replaceWith(a);
      } else {
        const link = sc.querySelector('a.title-link');
        if (!link) return;
        const span = document.createElement('span');
        span.className = 'title';
        span.textContent = findPrenomByCase(matrice, c);
        link.replaceWith(span);
      }
    });
    modeBtn.textContent = modeActive ? 'Quitter contrôle' : 'Mode contrôle';
  };

  // Export JSON
  document.getElementById('lien-box').onclick = () => {
    const infractionsByCat = {
      "Comportement": [], "Travail non fait": [], "Oubli de matériel": []
    };
    document.querySelectorAll('#result-list li:not(.detail-select)').forEach(li => {
      const [prenom, cat] = li.textContent.split(' : ');
      infractionsByCat[cat]?.push(li.textContent);
    });
    const subs = Array.from(document.querySelectorAll('.subcase'));
    const presents = subs.filter(sc => sc.classList.contains('selected')).length;
    const absents  = subs.filter(sc => !sc.classList.contains('selected'))
                         .map(sc => sc.querySelector('.title').textContent);
    const copiesOrdr = [];
    rendus.forEach(o => {
      for (let i = 0; i < o.pages; i++) {
        copiesOrdr.push(o.case ? findPrenomByCase(matrice, o.case) : "");
      }
    });
    const now = new Intl.DateTimeFormat('fr-FR', {
      timeZone:'Europe/Paris',year:'numeric',month:'2-digit',
      day:'2-digit',hour:'2-digit',minute:'2-digit'
    }).format(new Date()).replace(',','');
    const [dp,tp] = now.split(' ');
    const [jj,MM] = dp.split('/'), [hh,mm] = tp.split(':');
    const stamp = `${jj}-${MM}-${hh}h${mm}`;
    const output = {
      date: `${stamp} (Europe/Paris)`,
      infractions: infractionsByCat,
      presents,
      absents,
      "Copies dans l'ordre des rendus": copiesOrdr
    };
    const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `plan_de_classe_${stamp}.json`;
    document.body.append(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };
}

// Réinit général
document.getElementById('reset-box').onclick = () => { demandeInfosForm(); };

// Lance la première demande
demandeInfosForm();
</script>
</body>
</html>
