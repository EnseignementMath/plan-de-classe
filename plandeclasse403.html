<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plan de classe libre</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 0; background: #f3f8fc; }
    h1 { text-align: center; margin-top: 20px; }
    .container { display: flex; gap: 18px; align-items: flex-start; margin: 20px; }
    .left-panel { display: flex; flex-direction: column; gap: 10px; }
    .lien-box {
      width: 120px; padding: 10px; background-color: #87CEEB;
      border-radius: 5px; text-align: center; cursor: pointer;
      user-select: none; transition: background-color .3s, color .3s;
      margin-bottom: 0;
    }
    .lien-box:hover { background-color: #00bfff; }
    #mode-controle-box.active { background-color: #ff4d4d; color: #fff; }
    #reset-box {
      background: #ffb6c1 !important;
      color: #333;
      font-weight: bold;
      border: 1.2px solid #f06292;
    }
    .free-area {
      position: relative;
      width: 980px;
      min-height: 560px;
      border-radius: 12px;
      margin: 0 18px 0 0;
      overflow: visible;
      touch-action: none;
    }
    .student-card {
      position: absolute;
      left: 0; top: 0;
      width: 120px; min-height: 38px;
      background: #c6e6fa;
      border-radius: 10px;
      box-shadow: 0 1px 8px #a9b7c4a0;
      cursor: grab;
      user-select: none;
      z-index: 1;
      transition: box-shadow .2s, background .2s, color .2s, z-index .2s;
      display: flex; flex-direction: column; align-items: center;
      padding: 5px 8px 5px 8px;
      border: 1.3px solid #7dbbe6;
      touch-action: none;
    }
    .student-card.selected {
      background: #006400 !important; color: #fff !important;
    }
    .student-card.completed { background: #ff4d4d !important; color: #fff !important; }
    .student-card.dragging { opacity: 0.55; box-shadow: 0 0 16px #1473a3; z-index: 10000 !important; }
    .student-card.z-top { z-index: 1000 !important; }
    .header { display: flex; align-items: center; gap: 8px; width: 100%; }
    .toggle { cursor: pointer; }
    .title, .title-link { font-weight: bold; }
    .options {
      margin-top: 6px; display: none; padding-left: 4px;
      position: absolute; left: 110%; top: 0; background: #fff;
      border-radius: 7px; box-shadow: 0 2px 9px #0002;
      min-width: 145px; max-width: 180px; padding: 9px 7px 9px 7px;
      border: 1px solid #aaa; z-index: 1010;
    }
    .student-card .options,
    .student-card .options label,
    .student-card .options input[type="checkbox"] {
      color: #222 !important;
      filter: none !important;
      background: #fff !important;
    }
    .student-card .options input[type="checkbox"] {
      accent-color: #1473a3;
    }
    .result { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; min-width: 220px; background: #fff; }
    #result-list { list-style: none; padding: 0; margin: 0; }
    #result-list li { margin-bottom: 5px; cursor: pointer; }
    li.detail-select { padding-left: 20px; margin-bottom: 10px; }
    li.detail-select label { display: block; cursor: pointer; }
    #controle-result .control-message {
      text-decoration: underline; margin-top: 10px; font-weight: bold;
    }
    .footer-container { text-align: center; margin-top: 30px; }
    .footer-box {
      display: inline-block; padding: 10px 20px;
      border: 2px solid #000; border-radius: 5px; font-weight: bold;
    }
    @media (max-width:1000px) {
      .container { flex-direction: column; }
      .free-area { width: 98vw; min-width: unset; }
    }
  </style>
</head>
<body>
  <h1>Plan de classe — Positionnement libre</h1>
  <div class="container">
    <div class="left-panel">
      <div class="lien-box" id="lien-box">Lien</div>
      <div class="lien-box" id="appel-box">Appel terminé</div>
      <div class="lien-box" id="mode-controle-box">Mode contrôle</div>
      <div class="lien-box" id="reset-box">Nouvelle séance</div>
      <div id="appel-result"></div>
    </div>
    <div class="free-area" id="free-area"></div>
    <div class="result">
      <ul id="result-list"></ul>
      <div id="controle-result"></div>
    </div>
  </div>
  <div class="footer-container">
    <div class="footer-box">Tableau</div>
  </div>
<script>
const STORAGE_KEY = "plan_classe_2025";
const detailsOptions = {
  "Comportement": [
    "Insulte envers le professeur","Insulte envers un camarade","Insolence",
    "Langage familier","Refus de se taire","Refus de s'asseoir","Bavardages",
    "Imitation de bruitages","Usage du téléphone","Retard",
    "Insiste pour aller aux toilettes"
  ],
  "Travail non fait": [
    "Exercice maison non rendu","Copie blanche","Leçon non apprise",
    "Refus de participer","Réponse inappropriée"
  ],
  "Oubli de matériel": [
    "Pas de stylo","Pas de trousse","Pas de rapporteur","Pas de compas",
    "Pas ses codes","Pas de carnet","Pas de cahier","Pas de calculatrice",
    "Pas de mouchoirs","Pas de copie"
  ]
};

const eleves = [
  "Aya", "Roumaissa", "Mohamed", "Maryam", "Merve", "Néhémie", "Nemaaly", "Théo",
  "Mathys", "Sheldon", "Inahya", "Sam Ismaël", "Aissa", "Carlos", "Malone", "Raphaël",
  "Nour", "Jilyan", "Inès", "Ismael"
];

let positions = {};
let stateAppel = {};
let infractions = {};
let rendus = [];
let nomsRendus = [];

// Chargement des données si elles existent
function loadFromStorage() {
  const data = localStorage.getItem(STORAGE_KEY);
  if (!data) return false;
  try {
    const obj = JSON.parse(data);
    positions = obj.positions || {};
    stateAppel = obj.stateAppel || {};
    infractions = obj.infractions || {};
    rendus = obj.rendus || [];
    nomsRendus = obj.nomsRendus || [];
    return true;
  } catch {
    return false;
  }
}
// Sauvegarde
function saveToStorage() {
  const data = {
    positions, stateAppel, infractions, rendus, nomsRendus
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

const freeArea = document.getElementById('free-area');
const resultPanel = document.querySelector('.result');
const resultList = document.getElementById('result-list');
const modeBtn = document.getElementById('mode-controle-box');
const controleResult = document.getElementById('controle-result');
const appelResult = document.getElementById('appel-result');
const resetBtn = document.getElementById('reset-box');

function resetAll() {
  positions = {};
  stateAppel = {};
  infractions = {};
  rendus = [];
  nomsRendus = [];
  let w = freeArea.clientWidth || 900, x0 = 25, y0 = 28;
  let ncol = Math.ceil(Math.sqrt(eleves.length));
  eleves.forEach((nom, i) => {
    let r = Math.floor(i / ncol), c = i % ncol;
    positions[nom] = { x: x0 + c*140, y: y0 + r*70 };
    stateAppel[nom] = false;
    infractions[nom] = {};
  });
  saveToStorage();
  renderAll();
}

// === NOUVELLE SEANCE (réinitialise tout sauf les positions) ===
function nouvelleSeance() {
  // Ne touche pas à positions
  stateAppel = {};
  infractions = {};
  rendus = [];
  nomsRendus = [];
  eleves.forEach(nom => {
    stateAppel[nom] = false;
    infractions[nom] = {};
  });
  saveToStorage();
  renderAll();
}
resetBtn.onclick = nouvelleSeance;

if (!loadFromStorage()) resetAll();
else renderAll();

// Drag variables
let drag = { active: false, nom: null, node: null, offset: {x:0, y:0}, startX: 0, startY: 0, moved: false };

// Helper: test si le clic/tap est sur un input (coche/infraction)
function isInput(target) {
  return target.tagName === "INPUT" || target.closest(".options");
}

function renderAll() {
  freeArea.innerHTML = '';
  eleves.forEach((nom, idx) => {
    const pos = positions[nom] || {x: 40+idx*25, y: 30+idx*16};
    const sc = document.createElement('div');
    sc.className = 'student-card';
    sc.style.left = pos.x + "px";
    sc.style.top = pos.y + "px";
    sc.style.zIndex = 1;
    if(stateAppel[nom]) sc.classList.add('selected');
    if(rendus.find(e=>e.nom===nom)) sc.classList.add('completed');
    sc.setAttribute('data-nom', nom);
    sc.innerHTML = `
      <div class="header">
        <input type="checkbox" class="toggle" data-nom="${nom}" ${Object.keys(infractions[nom]).length ? "checked":""}>
        <span class="title">${nom}</span>
      </div>
      <div class="options" style="display:none"></div>
    `;
    let opts = sc.querySelector('.options');
    Object.keys(detailsOptions).forEach(cat => {
      const lbl = document.createElement('label');
      const inp = document.createElement('input');
      inp.type = 'checkbox';
      inp.dataset.nom = nom;
      inp.value = cat;
      if(infractions[nom] && infractions[nom][cat]) inp.checked = true;
      lbl.append(inp, ' ' + cat);
      opts.append(lbl, document.createElement('br'));
    });
    freeArea.appendChild(sc);

    // === CLIC/TAP BREF : toggle présence ===
    sc.addEventListener('click', function(e) {
      if(isInput(e.target)) return;
      stateAppel[nom] = !stateAppel[nom];
      sc.classList.toggle('selected', stateAppel[nom]);
      saveToStorage();
    });

    // === DRAG (PC & TABLETTE) ===
    sc.addEventListener('mousedown', function(e) {
      if(e.button!==0 || isInput(e.target)) return;
      drag.active = true; drag.nom = nom; drag.node = sc; drag.moved = false;
      drag.startX = e.clientX; drag.startY = e.clientY;
      drag.offset = { x: e.clientX - sc.offsetLeft, y: e.clientY - sc.offsetTop };
      document.body.style.userSelect = "none";
      document.body.style.overflow = "hidden";
    });
    document.addEventListener('mousemove', function(e) {
      if(drag.active) {
        let dx = e.clientX - drag.startX, dy = e.clientY - drag.startY;
        if(Math.abs(dx) > 6 || Math.abs(dy) > 6) drag.moved = true;
        if(drag.moved) {
          let nx = e.clientX - drag.offset.x;
          let ny = e.clientY - drag.offset.y;
          drag.node.style.left = nx + "px"; drag.node.style.top = ny + "px";
        }
      }
    });
    document.addEventListener('mouseup', function(e) {
      if(drag.active) {
        if(drag.moved) {
          positions[drag.nom] = {
            x: drag.node.offsetLeft,
            y: drag.node.offsetTop
          };
          saveToStorage();
        }
        drag.active = false; drag.nom = null; drag.node = null;
        document.body.style.userSelect = "";
        document.body.style.overflow = "";
      }
    });
    // DRAG tactile (tablette/stylet)
    sc.addEventListener('touchstart', function(e) {
      if(e.touches.length>1 || isInput(e.target)) return;
      drag.active = true; drag.nom = nom; drag.node = sc; drag.moved = false;
      drag.startX = e.touches[0].clientX; drag.startY = e.touches[0].clientY;
      drag.offset = {
        x: e.touches[0].clientX - sc.offsetLeft,
        y: e.touches[0].clientY - sc.offsetTop
      };
    }, {passive:false});
    sc.addEventListener('touchmove', function(e) {
      if(drag.active) {
        let dx = e.touches[0].clientX - drag.startX, dy = e.touches[0].clientY - drag.startY;
        if(Math.abs(dx)>6 || Math.abs(dy)>6) drag.moved = true;
        if(drag.moved) {
          let nx = e.touches[0].clientX - drag.offset.x;
          let ny = e.touches[0].clientY - drag.offset.y;
          drag.node.style.left = nx + "px"; drag.node.style.top = ny + "px";
        }
      }
      e.preventDefault();
    }, {passive:false});
    sc.addEventListener('touchend', function(e) {
      if(drag.active && drag.moved) {
        positions[nom] = {
          x: sc.offsetLeft,
          y: sc.offsetTop
        };
        saveToStorage();
      }
      drag.active = false; drag.nom = null; drag.node = null;
    });

    // INFRACTIONS popup devant
    let toggle = sc.querySelector('.toggle');
    toggle.addEventListener('change', function() {
      const opts = sc.querySelector('.options');
      document.querySelectorAll('.student-card').forEach(card => {
        card.classList.remove('z-top');
        if (card !== sc) card.querySelector('.options').style.display = 'none';
      });
      if (this.checked) {
        opts.style.display = 'block';
        sc.classList.add('z-top');
      } else {
        opts.style.display = 'none';
        sc.classList.remove('z-top');
        opts.querySelectorAll('input[type=checkbox]').forEach(cb => {
          cb.checked = false; delete infractions[nom][cb.value];
        });
      }
      saveToStorage();
    });
    opts.addEventListener('click', e=>e.stopPropagation());
    document.addEventListener('mousedown', function(e) {
      if (!sc.contains(e.target)) {
        opts.style.display = 'none';
        sc.classList.remove('z-top');
        toggle.checked = false;
      }
    });
    sc.querySelectorAll('.options input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', function() {
        if (this.checked) infractions[nom][this.value] = "";
        else delete infractions[nom][this.value];
        updateResultList();
        saveToStorage();
      });
    });
  });
  updateResultList();
}

function updateResultList() {
  resultList.innerHTML = '';
  eleves.forEach(nom => {
    Object.keys(infractions[nom]).forEach(cat => {
      const li = document.createElement('li');
      li.textContent = `${nom} : ${cat}`;
      li.onclick = function() {
        const prev = resultList.querySelector('.detail-select');
        if (prev) prev.remove();
        const opts = detailsOptions[cat];
        if (!opts) return;
        const sel = document.createElement('li');
        sel.className = 'detail-select';
        opts.forEach(opt => {
          const lbl = document.createElement('label');
          const cb  = document.createElement('input');
          cb.type = 'checkbox';
          cb.value = opt;
          cb.checked = infractions[nom][cat] === opt;
          lbl.append(cb, ' ' + opt);
          sel.append(lbl, document.createElement('br'));
          cb.addEventListener('change', () => {
            if (cb.checked) {
              infractions[nom][cat] = opt;
              li.textContent = `${nom} : ${cat} : ${opt}`;
              sel.remove();
              saveToStorage();
            }
          });
        });
        li.insertAdjacentElement('afterend', sel);
      };
      resultList.appendChild(li);
    });
  });
}

// Appel terminé
document.getElementById('appel-box').onclick = () => {
  const presents = eleves.filter(nom=>stateAppel[nom]).length;
  const absents = eleves.filter(nom=>!stateAppel[nom]);
  let html = `<p>Élèves présents : ${presents}</p><p>Élèves absents :</p>`;
  if (absents.length) absents.forEach(nom => {
    html += `<p>${nom}</p>`;
  }); else html += `<p>—</p>`;
  appelResult.innerHTML = html;
};

// Mode contrôle
let modeActive = false;
modeBtn.onclick = () => {
  modeActive = !modeActive;
  modeBtn.classList.toggle('active', modeActive);
  controleResult.innerHTML = modeActive
    ? '<p class="control-message">A terminé le contrôle</p>'
    : '';
  if (!modeActive) { rendus = []; nomsRendus = []; }
  document.querySelectorAll('.student-card').forEach(sc => {
    const nom = sc.getAttribute('data-nom');
    if (modeActive) {
      const span = sc.querySelector('span.title');
      if (!span) return;
      const a = document.createElement('a');
      a.href = '#'; a.textContent = nom; a.className = 'title-link';
      a.addEventListener('click', e => {
        e.stopPropagation();
        const line = document.createElement('p');
        line.innerHTML = `${nom} : page : <input type="number" min="1">`;
        controleResult.append(line);
        const input = line.querySelector('input');
        input.focus();
        input.addEventListener('keydown', evt => {
          if (evt.key === 'Enter') {
            const pages = parseInt(input.value, 10) || 0;
            line.textContent = `${nom} : page : ${pages}`;
            sc.classList.add('completed');
            rendus.push({ nom, pages });
            for (let i = 0; i < pages; i++) nomsRendus.push(nom);
            saveToStorage();
          }
        });
      });
      span.replaceWith(a);
    } else {
      const link = sc.querySelector('a.title-link');
      if (!link) return;
      const span = document.createElement('span');
      span.className = 'title';
      span.textContent = nom;
      link.replaceWith(span);
    }
  });
  modeBtn.textContent = modeActive ? 'Quitter contrôle' : 'Mode contrôle';
  saveToStorage();
};

// Export JSON (sans positions)
document.getElementById('lien-box').onclick = () => {
  const infractionsByCat = { "Comportement": [], "Travail non fait": [], "Oubli de matériel": [] };
  eleves.forEach(nom=>{
    Object.keys(infractions[nom]).forEach(cat=>{
      if(cat in infractionsByCat)
        infractionsByCat[cat].push(`${nom} : ${cat}` + (infractions[nom][cat] ? ` : ${infractions[nom][cat]}` : ""));
    });
  });
  const presents = eleves.filter(nom=>stateAppel[nom]).length;
  const absents = eleves.filter(nom=>!stateAppel[nom]);
  const copiesOrdr = [];
  rendus.forEach(o => {
    for (let i = 0; i < o.pages; i++) copiesOrdr.push(o.nom);
  });
  const now = new Intl.DateTimeFormat('fr-FR', {
    timeZone:'Europe/Paris',year:'numeric',month:'2-digit',
    day:'2-digit',hour:'2-digit',minute:'2-digit'
  }).format(new Date()).replace(',','');
  const [dp,tp] = now.split(' ');
  const [jj,MM] = dp.split('/'), [hh,mm] = tp.split(':');
  const stamp = `${jj}-${MM}-${hh}h${mm}`;
  const output = {
    date: `${stamp} (Europe/Paris)`,
    infractions: infractionsByCat,
    presents,
    absents,
    "Copies dans l'ordre des rendus": copiesOrdr
  };
  const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `plan_de_classe_${stamp}.json`;
  document.body.append(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
